AWSTemplateFormatVersion: '2010-09-09'
Description: 'Strands Agents ì›Œí¬ìƒµ í†µí•© ë°°í¬ - ëª¨ë“  ë¦¬ì†ŒìŠ¤ë¥¼ í•œ ë²ˆì— ë°°í¬ (ë§ˆìŠ¤í„° ìŠ¤íƒ)'

Parameters:
  DatabaseName:
    Type: String
    Default: agentdb
    Description: PostgreSQL ë°ì´í„°ë² ì´ìŠ¤ ì´ë¦„
  DBUsername:
    Type: String
    Default: dbadmin
    Description: ë°ì´í„°ë² ì´ìŠ¤ ì‚¬ìš©ìëª… (adminì€ ì˜ˆì•½ì–´ì´ë¯€ë¡œ ì‚¬ìš© ë¶ˆê°€)
  DBPassword:
    Type: String
    Default: StrandsAgent2024!
    NoEcho: true
    Description: ë°ì´í„°ë² ì´ìŠ¤ íŒ¨ìŠ¤ì›Œë“œ (ìµœì†Œ 8ì)
    MinLength: 8

  WorkshopUserEmail:
    Type: String
    Default: workshop-user@example.com
    Description: ì›Œí¬ìƒµ ì‚¬ìš©ì ì´ë©”ì¼ (ê¸°ë³¸ê°’ ì‚¬ìš©)

  DeploymentNotificationTopic:
    Type: String
    Default: strands-workshop-notifications
    Description: ë°°í¬ ìƒíƒœ ì•Œë¦¼ SNS í† í”½ëª… (ë‚´ë¶€ ëª¨ë‹ˆí„°ë§ìš©)

Mappings:
  RegionMap:
    us-east-1:
      PandasLayer: arn:aws:lambda:us-east-1:336392948345:layer:AWSSDKPandas-Python39:11
      Psycopg2Layer: arn:aws:lambda:us-east-1:898466741470:layer:psycopg2-py39:7
    us-west-2:
      PandasLayer: arn:aws:lambda:us-west-2:336392948345:layer:AWSSDKPandas-Python39:11
      Psycopg2Layer: arn:aws:lambda:us-west-2:898466741470:layer:psycopg2-py39:7

Resources:
  # ë°°í¬ ìƒíƒœ ì•Œë¦¼ìš© SNS í† í”½
  DeploymentNotifications:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Ref DeploymentNotificationTopic
      DisplayName: Strands Workshop ë°°í¬ ì•Œë¦¼
      Subscription:
        - Protocol: email
          Endpoint: !Ref WorkshopUserEmail

  # 1ë‹¨ê³„: ë„¤íŠ¸ì›Œí‚¹ ë° PostgreSQL (ì¦‰ì‹œ ì‹œì‘, 15-20ë¶„ ì†Œìš”)
  PostgreSQLStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: https://aws-workshop-templates-public.s3.amazonaws.com/strands-agents-life-science/postgres_stack.yaml
      Parameters:
        DatabaseName: !Ref DatabaseName
        DBUsername: !Ref DBUsername
        DBPassword: !Ref DBPassword
      NotificationARNs:
        - !Ref DeploymentNotifications
      Tags:
        - Key: WorkshopComponent
          Value: PostgreSQL
        - Key: DeploymentOrder
          Value: "1"

  # 2ë‹¨ê³„: Knowledge Base (PostgreSQL ì™„ë£Œ í›„ ì‹œì‘, 10-15ë¶„ ì†Œìš”)
  KnowledgeBaseStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: PostgreSQLStack
    Properties:
      TemplateURL: https://aws-workshop-templates-public.s3.amazonaws.com/strands-agents-life-science/kb_stack.yaml
      Parameters:
        VPCId: !GetAtt PostgreSQLStack.Outputs.VPCId
        PrivateSubnet1: !GetAtt PostgreSQLStack.Outputs.PrivateSubnet1
        PrivateSubnet2: !GetAtt PostgreSQLStack.Outputs.PrivateSubnet2
      NotificationARNs:
        - !Ref DeploymentNotifications
      Tags:
        - Key: WorkshopComponent
          Value: KnowledgeBase
        - Key: DeploymentOrder
          Value: "2"

  # 3ë‹¨ê³„: ë‹¨ë°±ì§ˆ ì„¤ê³„ í™˜ê²½ (Knowledge Base ì™„ë£Œ í›„ ì‹œì‘, 10-15ë¶„ ì†Œìš”)
  ProteinDesignStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: KnowledgeBaseStack
    Properties:
      TemplateURL: https://aws-workshop-templates-public.s3.amazonaws.com/strands-agents-life-science/protein_design_stack.yaml
      Parameters:
        VPCId: !GetAtt PostgreSQLStack.Outputs.VPCId
        PrivateSubnet1: !GetAtt PostgreSQLStack.Outputs.PrivateSubnet1
        KnowledgeBaseId: !GetAtt KnowledgeBaseStack.Outputs.KnowledgeBaseId
      NotificationARNs:
        - !Ref DeploymentNotifications
      Tags:
        - Key: WorkshopComponent
          Value: ProteinDesign
        - Key: DeploymentOrder
          Value: "3"

  # ë°°í¬ ìƒíƒœ ì¶”ì  Lambda í•¨ìˆ˜
  DeploymentStatusFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: strands-deployment-status-tracker
      Runtime: python3.9
      Handler: index.lambda_handler
      Role: !GetAtt DeploymentStatusRole.Arn
      Environment:
        Variables:
          SNS_TOPIC_ARN: !Ref DeploymentNotifications
          MASTER_STACK_NAME: !Ref AWS::StackName
      Code:
        ZipFile: |
          import boto3
          import json
          import os

          def lambda_handler(event, context):
              """ë°°í¬ ìƒíƒœ ì¶”ì  ë° ì•Œë¦¼"""

              sns = boto3.client('sns')
              cfn = boto3.client('cloudformation')

              try:
                  master_stack = os.environ['MASTER_STACK_NAME']
                  topic_arn = os.environ['SNS_TOPIC_ARN']

                  # ë§ˆìŠ¤í„° ìŠ¤íƒ ìƒíƒœ í™•ì¸
                  response = cfn.describe_stacks(StackName=master_stack)
                  stack_status = response['Stacks'][0]['StackStatus']

                  # ì¤‘ì²© ìŠ¤íƒë“¤ ìƒíƒœ í™•ì¸
                  nested_stacks = cfn.list_stack_resources(StackName=master_stack)

                  postgres_status = "PENDING"
                  kb_status = "PENDING"
                  protein_status = "PENDING"

                  for resource in nested_stacks['StackResourceSummaries']:
                      if 'PostgreSQL' in resource['LogicalResourceId']:
                          postgres_status = resource['ResourceStatus']
                      elif 'KnowledgeBase' in resource['LogicalResourceId']:
                          kb_status = resource['ResourceStatus']
                      elif 'ProteinDesign' in resource['LogicalResourceId']:
                          protein_status = resource['ResourceStatus']

                  # ìƒíƒœ ë©”ì‹œì§€ ìƒì„±
                  message = f"""
ğŸš€ Strands Agents ì›Œí¬ìƒµ ë°°í¬ ìƒíƒœ ì—…ë°ì´íŠ¸

ğŸ“Š ì „ì²´ ì§„í–‰ìƒí™©:
â€¢ PostgreSQL & ë„¤íŠ¸ì›Œí‚¹: {postgres_status}
â€¢ Knowledge Base: {kb_status}
â€¢ ë‹¨ë°±ì§ˆ ì„¤ê³„ í™˜ê²½: {protein_status}

â±ï¸ ë‹¤ìŒ ë‹¨ê³„:
{get_next_steps(postgres_status, kb_status, protein_status)}

ğŸ”— ì§„í–‰í•˜ë©´ì„œ í™•ì¸í•˜ì„¸ìš”:
AWS ì½˜ì†” > CloudFormation > {master_stack}
                  """

                  sns.publish(
                      TopicArn=topic_arn,
                      Subject='ì›Œí¬ìƒµ ë°°í¬ ìƒíƒœ ì—…ë°ì´íŠ¸',
                      Message=message
                  )

                  return {
                      'statusCode': 200,
                      'body': json.dumps({
                          'postgres': postgres_status,
                          'knowledgebase': kb_status,
                          'protein': protein_status
                      })
                  }

              except Exception as e:
                  print(f"Error: {e}")
                  return {
                      'statusCode': 500,
                      'body': json.dumps({'error': str(e)})
                  }

          def get_next_steps(postgres, kb, protein):
              """ë‹¤ìŒ ë‹¨ê³„ ì•ˆë‚´"""
              if postgres == "CREATE_COMPLETE" and kb == "CREATE_COMPLETE" and protein == "CREATE_COMPLETE":
                  return "âœ… ëª¨ë“  ë°°í¬ ì™„ë£Œ! ì‹¤ìŠµ 2ë¡œ ì§„í–‰í•˜ì„¸ìš”."
              elif postgres == "CREATE_COMPLETE" and kb == "CREATE_COMPLETE":
                  return "â³ ë‹¨ë°±ì§ˆ ì„¤ê³„ í™˜ê²½ ë°°í¬ ì¤‘... ì‹¤ìŠµ 1 ì™„ë£Œ í›„ ì‹¤ìŠµ 2 ì‹œì‘ ê°€ëŠ¥"
              elif postgres == "CREATE_COMPLETE":
                  return "â³ Knowledge Base ë°°í¬ ì¤‘... ì‹¤ìŠµ 1ì„ ê³„ì† ì§„í–‰í•˜ì„¸ìš”"
              else:
                  return "â³ PostgreSQL ë°°í¬ ì¤‘... ì‹¤ìŠµ 1ì„ ì‹œì‘í•˜ì„¸ìš”"

  # Lambda ì‹¤í–‰ ì—­í• 
  DeploymentStatusRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: DeploymentStatusPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - cloudformation:DescribeStacks
                  - cloudformation:ListStackResources
                  - sns:Publish
                Resource: '*'

  # ë°°í¬ ìƒíƒœ ëª¨ë‹ˆí„°ë§ EventBridge ê·œì¹™
  DeploymentMonitorRule:
    Type: AWS::Events::Rule
    Properties:
      Name: strands-deployment-monitor
      Description: CloudFormation ìŠ¤íƒ ìƒíƒœ ë³€ê²½ ëª¨ë‹ˆí„°ë§
      EventPattern:
        source:
          - aws.cloudformation
        detail-type:
          - CloudFormation Stack Status Change
        detail:
          stack-id:
            - !Ref AWS::StackId
      State: ENABLED
      Targets:
        - Arn: !GetAtt DeploymentStatusFunction.Arn
          Id: DeploymentStatusTarget

  # EventBridgeê°€ Lambdaë¥¼ í˜¸ì¶œí•  ìˆ˜ ìˆëŠ” ê¶Œí•œ
  LambdaInvokePermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref DeploymentStatusFunction
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt DeploymentMonitorRule.Arn

Outputs:
  # PostgreSQL ê´€ë ¨ ì¶œë ¥
  DatabaseEndpoint:
    Description: PostgreSQL ë°ì´í„°ë² ì´ìŠ¤ ì—”ë“œí¬ì¸íŠ¸
    Value: !GetAtt PostgreSQLStack.Outputs.DatabaseEndpoint
    Export:
      Name: !Sub "${AWS::StackName}-DatabaseEndpoint"

  VPCId:
    Description: ìƒì„±ëœ VPC ID
    Value: !GetAtt PostgreSQLStack.Outputs.VPCId
    Export:
      Name: !Sub "${AWS::StackName}-VPCId"

  # Knowledge Base ê´€ë ¨ ì¶œë ¥
  KnowledgeBaseId:
    Description: Bedrock Knowledge Base ID
    Value: !GetAtt KnowledgeBaseStack.Outputs.KnowledgeBaseId
    Export:
      Name: !Sub "${AWS::StackName}-KnowledgeBaseId"

  # ë‹¨ë°±ì§ˆ ì„¤ê³„ ê´€ë ¨ ì¶œë ¥
  ProteinWorkflowId:
    Description: HealthOmics ì›Œí¬í”Œë¡œìš° ID
    Value: !GetAtt ProteinDesignStack.Outputs.ProteinWorkflowId
    Export:
      Name: !Sub "${AWS::StackName}-ProteinWorkflowId"

  # ë°°í¬ ìƒíƒœ ì¶”ì 
  DeploymentStatusFunction:
    Description: ë°°í¬ ìƒíƒœ ì¶”ì  Lambda í•¨ìˆ˜
    Value: !Ref DeploymentStatusFunction

  SNSTopicArn:
    Description: ë°°í¬ ì•Œë¦¼ SNS í† í”½
    Value: !Ref DeploymentNotifications

  # ì›Œí¬ìƒµ ì§„í–‰ ì•ˆë‚´
  WorkshopInstructions:
    Description: ì›Œí¬ìƒµ ì§„í–‰ ë°©ë²•
    Value: |
      ğŸš€ ë°°í¬ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!

      ğŸ“§ ì´ë©”ì¼ë¡œ ë°°í¬ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”
      ğŸ““ ì§€ê¸ˆ ë°”ë¡œ ì‹¤ìŠµ 1(í™˜ê²½ ì„¤ì •)ì„ ì‹œì‘í•˜ì„¸ìš”
      â±ï¸ ì‹¤ìŠµ 1 ì™„ë£Œ ì‹œì ì— ëª¨ë“  ì¸í”„ë¼ê°€ ì¤€ë¹„ë©ë‹ˆë‹¤

      ë‹¤ìŒ ë‹¨ê³„:
      1. SageMaker Studio ì ‘ì†
      2. GitHub ì½”ë“œ í´ë¡ 
      3. 00-setup_environment.ipynb ì‹¤í–‰
      4. ë°°í¬ ì™„ë£Œ ì´ë©”ì¼ í™•ì¸ í›„ ì‹¤ìŠµ 2 ì§„í–‰

  EstimatedCompletionTime:
    Description: ì˜ˆìƒ ì™„ë£Œ ì‹œê°„
    Value: "35-45ë¶„ (PostgreSQL 20ë¶„ + Knowledge Base 15ë¶„ + ë‹¨ë°±ì§ˆ í™˜ê²½ 10ë¶„)"